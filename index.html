<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Freechatbook - Safe Login</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Libraries (Stable Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0866FF; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Button Loading State */
        .btn-loading { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- Auth System -->
    <div id="authPage" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center p-6">
        <h1 class="text-[#0866FF] text-4xl font-black italic mb-4">freechatbook</h1>
        <p class="text-gray-400 mb-6 text-sm">Super Fast Lite Version</p>
        
        <!-- Login Box -->
        <div id="loginBox" class="w-full max-w-sm">
            <input type="text" id="lUser" placeholder="ইউজারনাম" class="w-full border p-3 rounded mb-3 bg-gray-50 outline-blue-500">
            <input type="password" id="lPass" placeholder="পাসওয়ার্ড" class="w-full border p-3 rounded mb-4 bg-gray-50 outline-blue-500">
            <button onclick="handleAuth('login')" id="btnLogin" class="w-full bg-[#0866FF] text-white py-3 rounded font-bold text-lg hover:bg-blue-700 transition">Log In</button>
            <button onclick="toggleAuth('signup')" class="w-full mt-4 text-[#42b72a] font-bold">Create New Account</button>
        </div>

        <!-- Signup Box -->
        <div id="signupBox" class="w-full max-w-sm hidden">
            <input type="text" id="rUser" placeholder="নতুন ইউজারনাম (ছোট হাতের)" class="w-full border p-3 rounded mb-3 bg-gray-50 outline-green-500">
            <input type="password" id="rPass" placeholder="নতুন পাসওয়ার্ড" class="w-full border p-3 rounded mb-4 bg-gray-50 outline-green-500">
            <button onclick="handleAuth('signup')" id="btnSignup" class="w-full bg-[#42b72a] text-white py-3 rounded font-bold text-lg hover:bg-green-700 transition">Sign Up</button>
            <button onclick="toggleAuth('login')" class="w-full mt-4 text-blue-600 font-bold">Back to Login</button>
        </div>
        
        <div id="statusMsg" class="mt-4 text-red-500 text-sm font-bold text-center"></div>
        <button onclick="resetApp()" class="mt-10 text-gray-400 text-xs underline">Trouble logging in? Reset App</button>
    </div>

    <!-- Main App UI -->
    <div id="mainApp" class="hidden max-w-lg mx-auto bg-gray-100 min-h-screen">
        <!-- Navbar -->
        <nav class="bg-white sticky top-0 z-50 border-b shadow-sm">
            <div class="flex justify-between items-center p-3">
                <h1 class="text-[#0866FF] text-2xl font-black italic cursor-pointer" onclick="location.reload()">freechatbook</h1>
                <i onclick="logout()" class="fas fa-power-off text-red-500 text-xl cursor-pointer bg-red-50 p-2 rounded-full"></i>
            </div>
        </nav>

        <!-- Feed Section -->
        <div class="p-3">
            <div class="bg-white p-4 rounded shadow-sm text-center mb-4">
                <h2 class="text-xl font-bold mb-2">Welcome!</h2>
                <div class="p-3 bg-gray-100 rounded mb-3 flex items-center justify-between">
                    <span class="font-bold text-gray-700">Create Post</span>
                    <button onclick="openPostModal()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold">Write</button>
                </div>
            </div>
            <div id="feedList" class="flex flex-col gap-3">
                <div class="text-center py-10 text-gray-400">Loading posts...</div>
            </div>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="fixed inset-0 bg-white z-[100] hidden flex flex-col">
        <div class="flex justify-between items-center p-3 border-b shadow-sm">
            <div class="flex items-center gap-2"><i onclick="document.getElementById('postModal').classList.add('hidden')" class="fas fa-times text-xl p-2"></i> <span class="font-bold">New Post</span></div>
            <button onclick="submitPost()" id="postBtn" class="bg-blue-600 text-white px-6 py-1.5 rounded font-bold text-sm">POST</button>
        </div>
        <textarea id="pText" class="w-full p-4 text-lg outline-none flex-1 resize-none" placeholder="What's on your mind?"></textarea>
        <div id="pImgArea" class="hidden p-2 relative bg-gray-50 border-t">
            <img id="pImgPreview" class="h-40 mx-auto object-contain">
            <button onclick="clearImg()" class="absolute top-2 right-2 text-red-500 bg-white rounded-full p-1 shadow">Remove</button>
        </div>
        <div class="p-3 border-t bg-gray-50">
            <label class="flex items-center gap-2 text-green-600 font-bold cursor-pointer">
                <i class="fas fa-image text-xl"></i> Add Photo
                <input type="file" id="pImgInput" class="hidden" accept="image/*" onchange="previewFile(this)">
            </label>
        </div>
    </div>

    <script>
        // CONFIG
        const IMGBB_API_KEY = "3d8496a83cf59cbff6ea657e72fa8688";
        const firebaseConfig = {
            apiKey: "AIzaSyDlrDXIji286w0wBPqta0mftEhPxS3M9BM",
            authDomain: "freechatbook-42f04.firebaseapp.com",
            databaseURL: "https://freechatbook-42f04-default-rtdb.firebaseio.com",
            projectId: "freechatbook-42f04",
            storageBucket: "freechatbook-42f04.appspot.com",
            messagingSenderId: "784680329144",
            appId: "1:784680329144:web:ccacf6e9d71fd25772394d"
        };

        // Initialize Firebase safely
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase Connected");
        } catch (e) {
            alert("Internet Error: Firebase failed to load. Please refresh.");
            console.error(e);
        }

        // Check Login Status
        let user = null;
        try {
            user = JSON.parse(localStorage.getItem('fcb_user_safe'));
        } catch(e) { localStorage.removeItem('fcb_user_safe'); }

        if (user) {
            showMainApp();
        } else {
            document.getElementById('authPage').classList.remove('hidden');
        }

        // --- AUTH FUNCTIONS ---
        function handleAuth(type) {
            const btn = document.getElementById(type === 'login' ? 'btnLogin' : 'btnSignup');
            const status = document.getElementById('statusMsg');
            const uInput = document.getElementById(type === 'login' ? 'lUser' : 'rUser');
            const pInput = document.getElementById(type === 'login' ? 'lPass' : 'rPass');
            
            const u = uInput.value.trim().toLowerCase().replace(/\s/g, '');
            const p = pInput.value.trim();

            if (!u || !p) {
                status.innerText = "Please enter both Username and Password";
                return;
            }

            // Visual Feedback
            const originalText = btn.innerText;
            btn.innerText = type === 'login' ? "Checking..." : "Creating Account...";
            btn.classList.add('btn-loading');
            btn.disabled = true;
            status.innerText = "";

            if(!db) { alert("Database not connected. Check internet."); restoreBtn(); return; }

            const ref = db.ref('users/' + u);

            if (type === 'signup') {
                ref.once('value', s => {
                    if (s.exists()) {
                        status.innerText = "Username already taken!";
                        restoreBtn();
                    } else {
                        const data = { name: u, pass: p, pfp: "https://cdn-icons-png.flaticon.com/512/149/149071.png", joined: Date.now() };
                        ref.set(data).then(() => {
                            localStorage.setItem('fcb_user_safe', JSON.stringify(data));
                            location.reload();
                        }).catch(e => {
                            status.innerText = "Error: " + e.message;
                            restoreBtn();
                        });
                    }
                });
            } else {
                ref.once('value', s => {
                    const val = s.val();
                    if (val && val.pass === p) {
                        localStorage.setItem('fcb_user_safe', JSON.stringify(val));
                        location.reload();
                    } else {
                        status.innerText = "Wrong Username or Password!";
                        restoreBtn();
                    }
                }, error => {
                    status.innerText = "Network Error. Check internet.";
                    restoreBtn();
                });
            }

            function restoreBtn() {
                btn.innerText = originalText;
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        function toggleAuth(type) {
            document.getElementById('loginBox').classList.toggle('hidden', type === 'signup');
            document.getElementById('signupBox').classList.toggle('hidden', type === 'login');
            document.getElementById('statusMsg').innerText = "";
        }

        function showMainApp() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadFeed();
        }

        function logout() {
            if(confirm("Log out?")) {
                localStorage.removeItem('fcb_user_safe');
                location.reload();
            }
        }

        function resetApp() {
            if(confirm("This will clear app data and refresh. OK?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- POSTING & ImgBB ---
        function openPostModal() { document.getElementById('postModal').classList.remove('hidden'); }
        
        function previewFile(input) {
            const file = input.files[0];
            if(file) {
                document.getElementById('pImgArea').classList.remove('hidden');
                document.getElementById('pImgPreview').src = URL.createObjectURL(file);
            }
        }
        function clearImg() {
            document.getElementById('pImgArea').classList.add('hidden');
            document.getElementById('pImgInput').value = '';
        }

        async function submitPost() {
            const btn = document.getElementById('postBtn');
            const txt = document.getElementById('pText').value.trim();
            const file = document.getElementById('pImgInput').files[0];

            if(!txt && !file) return alert("Write something!");

            btn.innerText = "Processing...";
            btn.disabled = true;

            let imgUrl = null;

            if(file) {
                btn.innerText = "Uploading Img...";
                try {
                    // Resize Image Logic (Canvas)
                    const resizedBlob = await resizeImage(file);
                    const formData = new FormData();
                    formData.append('image', resizedBlob);
                    
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    if(data.success) imgUrl = data.data.url;
                    else throw new Error("Upload failed");
                } catch(e) {
                    alert("Image upload failed. Try again.");
                    btn.innerText = "POST";
                    btn.disabled = false;
                    return;
                }
            }

            btn.innerText = "Publishing...";
            db.ref('posts').push({
                uName: user.name,
                content: txt,
                image: imgUrl,
                time: Date.now()
            }).then(() => {
                document.getElementById('postModal').classList.add('hidden');
                document.getElementById('pText').value = '';
                clearImg();
                btn.innerText = "POST";
                btn.disabled = false;
            });
        }

        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800; 
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(resolve, 'image/jpeg', 0.7);
                    };
                };
            });
        }

        function loadFeed() {
            db.ref('posts').limitToLast(20).on('value', snap => {
                const list = document.getElementById('feedList');
                list.innerHTML = '';
                if(!snap.exists()) { list.innerHTML = '<div class="text-center text-gray-400">No posts yet.</div>'; return; }
                
                const posts = [];
                snap.forEach(c => posts.push(c.val()));
                
                posts.reverse().forEach(p => {
                    list.innerHTML += `
                    <div class="bg-white p-3 rounded shadow-sm">
                        <div class="font-bold text-blue-600 mb-1">${p.uName}</div>
                        <div class="mb-2 whitespace-pre-wrap">${p.content}</div>
                        ${p.image ? `<img src="${p.image}" class="w-full rounded max-h-80 object-cover bg-gray-100">` : ''}
                        <div class="text-xs text-gray-400 mt-2">${new Date(p.time).toLocaleString()}</div>
                    </div>`;
                });
            });
        }
    </script>
</body>
</html>
